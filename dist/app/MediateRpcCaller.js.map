{"version":3,"sources":["app/MediateRpcCaller.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA,mCAAsC;AAEtC,6BAA6B;AAC7B,+DAAuG;AAEvG,mCAAqC;AAErC,mCAAmC;AAOnC,IAAa,sBAAsB,GAAnC,4BACG,SAAQ,GAAG,CAAC,aAAa;IAK3B,YACyC,cAAuC;QAE/E,KAAK,EAAE,CAAC;QAFgC,mBAAc,GAAd,cAAc,CAAyB;QAG/E,4BAAK,CAAC,aAAa,CAAC,gBAAgB,EAAE,cAAc,CAAC,CAAC;QAEtD,IAAI,CAAC,QAAQ,GAAG,IAAI,qBAAY,EAAE,CAAC;QACnC,IAAI,CAAC,cAAc,CAAC,KAAK,GAAG,EAAE,CAAC,CAAC,gDAAgD;IACjF,CAAC;IAED;;OAEG;IACI,IAAI,CAAC,MAAY;IACxB,CAAC;IAED;;OAEG;IACI,IAAI,CAAC,UAAkB,EAAE,MAAc,EAAE,MAAY;QAC3D,4BAAK,CAAC,aAAa,CAAC,YAAY,EAAE,UAAU,CAAC,CAAC;QAC9C,4BAAK,CAAC,aAAa,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QAEtC,MAAM,CAAC,IAAI,OAAO,CAAmB,CAAC,OAAO,EAAE,MAAM;YACpD,0FAA0F;YAC1F,iEAAiE;YACjE,MAAM,aAAa,GAAG,IAAI,CAAC,EAAE,EAAE,EAC9B,OAAO,GAAG,YAAY,UAAU,IAAI,MAAM,EAAE,CAAC;YAE9C,IAAI,CAAC,cAAc,CAAC,SAAS,CAAC,OAAO,EAAE,CAAC,GAAa;gBACpD,8DAA8D;gBAC9D,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC,aAAa,EAAE,GAAG,CAAC,CAAC;YACvD,CAAC,CAAC;iBACD,IAAI,CAAC,WAAW;gBAChB,gGAAgG;gBAChG,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,aAAa,EAAE,CAAO,GAAa;oBACrD,uCAAuC;oBACvC,MAAM,IAAI,CAAC,cAAc,CAAC,WAAW,CAAC,WAAW,CAAC,CAAC;oBACnD,OAAO,CAAmB,GAAG,CAAC,IAAI,CAAC,CAAC;gBACrC,CAAC,CAAA,CAAC,CAAC;gBAEH,IAAI,OAAO,GAAoB;oBAC9B,IAAI,EAAE,IAAI,CAAC,KAAK;oBAChB,EAAE,EAAE,UAAU;oBACd,MAAM;iBACN,CAAC;gBAEF,wDAAwD;gBACxD,MAAM,CAAC,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,WAAW,UAAU,IAAI,MAAM,EAAE,EAAE,OAAO,EAC5E,EAAE,aAAa,EAAE,OAAO,EAAE,CAAC,CAAC;YAC9B,CAAC,CAAC;iBACD,KAAK,CAAC,GAAG;gBACT,MAAM,CAAC,IAAI,qCAAc,CAAC,cAAc,GAAG,EAAE,CAAC,CAAC,CAAC;YACjD,CAAC,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;IACJ,CAAC;CACD,CAAA;AA9DY,sBAAsB;IADlC,iCAAU,EAAE;IAQV,WAAA,6BAAM,CAAC,aAAC,CAAC,oBAAoB,CAAC,CAAA;;GAPpB,sBAAsB,CA8DlC;AA9DY,wDAAsB","file":"MediateRpcCaller.js","sourcesContent":["import { EventEmitter } from 'events';\r\n\r\nimport * as uuid from 'uuid';\r\nimport { injectable, inject, IDependencyContainer, Guard, MinorException } from 'back-lib-common-util';\r\n\r\nimport { Types as T } from './Types';\r\nimport { IMessageBrokerConnector, IMessage } from './MessageBrokerConnector';\r\nimport * as rpc from './RpcCommon';\r\n\r\n\r\nexport interface IMediateRpcCaller extends rpc.IRpcCaller {\r\n}\r\n\r\n@injectable()\r\nexport class MessageBrokerRpcCaller\r\n\t\t\textends rpc.RpcCallerBase\r\n\t\t\timplements IMediateRpcCaller {\r\n\r\n\tprivate _emitter: EventEmitter;\r\n\r\n\tconstructor(\r\n\t\t@inject(T.MSG_BROKER_CONNECTOR) private _msgBrokerConn: IMessageBrokerConnector\r\n\t) {\r\n\t\tsuper();\r\n\t\tGuard.assertDefined('_msgBrokerConn', _msgBrokerConn);\r\n\r\n\t\tthis._emitter = new EventEmitter();\r\n\t\tthis._msgBrokerConn.queue = ''; // Make sure we only use temporary unique queue.\r\n\t}\r\n\r\n\t/**\r\n\t * @see IRpcCaller.init\r\n\t */\r\n\tpublic init(params?: any): void {\r\n\t}\r\n\r\n\t/**\r\n\t * @see IRpcCaller.call\r\n\t */\r\n\tpublic call(moduleName: string, action: string, params?: any): Promise<rpc.IRpcResponse> {\r\n\t\tGuard.assertDefined('moduleName', moduleName);\r\n\t\tGuard.assertDefined('action', action);\r\n\r\n\t\treturn new Promise<rpc.IRpcResponse>((resolve, reject) => {\r\n\t\t\t// There are many requests to same `requestTopic` and they listen to same `responseTopic`,\r\n\t\t\t// A request only carea for a response with same `correlationId`.\r\n\t\t\tconst correlationId = uuid.v4(),\r\n\t\t\t\treplyTo = `response.${moduleName}.${action}`;\r\n\r\n\t\t\tthis._msgBrokerConn.subscribe(replyTo, (msg: IMessage) => {\r\n\t\t\t\t// Announce that we've got a response with this correlationId.\r\n\t\t\t\tthis._emitter.emit(msg.properties.correlationId, msg);\r\n\t\t\t})\r\n\t\t\t.then(consumerTag => {\r\n\t\t\t\t// TODO: Should have a timeout to remove this listener, in case this request never has response.\r\n\t\t\t\tthis._emitter.once(correlationId, async (msg: IMessage) => {\r\n\t\t\t\t\t// We got what we want, stop consuming.\r\n\t\t\t\t\tawait this._msgBrokerConn.unsubscribe(consumerTag);\r\n\t\t\t\t\tresolve(<rpc.IRpcResponse>msg.data);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tlet request: rpc.IRpcRequest = {\r\n\t\t\t\t\tfrom: this._name,\r\n\t\t\t\t\tto: moduleName,\r\n\t\t\t\t\tparams\r\n\t\t\t\t};\r\n\r\n\t\t\t\t// Send request, marking the message with correlationId.\r\n\t\t\t\treturn this._msgBrokerConn.publish(`request.${moduleName}.${action}`, request, \r\n\t\t\t\t\t{ correlationId, replyTo });\r\n\t\t\t})\r\n\t\t\t.catch(err => {\r\n\t\t\t\treject(new MinorException(`RPC error: ${err}`));\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n}"]}
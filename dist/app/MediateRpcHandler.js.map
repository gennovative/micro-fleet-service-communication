{"version":3,"sources":["app/MediateRpcHandler.ts"],"names":[],"mappings":"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","file":"MediateRpcHandler.js","sourcesContent":["import { injectable, inject, IDependencyContainer, Guard, Exception, Types as CmT } from 'back-lib-common-util';\r\n\r\nimport { Types as T } from './Types';\r\nimport { IMessageBrokerConnector, IMessage, MessageHandleFunction } from './MessageBrokerConnector';\r\nimport * as rpc from './RpcCommon';\r\n\r\n\r\nexport interface IHandlerDetails {\r\n\tdependencyIdentifier: string | symbol;\r\n\tactionFactory?: rpc.RpcActionFactory;\r\n}\r\n\r\nexport interface IMediateRpcHandler extends rpc.IRpcHandler {\r\n\t/**\r\n\t * @override IRpcHandler.handle to return Promise<void>\r\n\t */\r\n\thandle(actions: string | string[], dependencyIdentifier: string | symbol, actionFactory?: rpc.RpcActionFactory): Promise<void>;\r\n\t\r\n\t/**\r\n\t * Handles countAll, create, delete, find, patch, update.\r\n\t */\r\n\thandleCRUD(dependencyIdentifier: string | symbol, actionFactory?: rpc.RpcActionFactory): Promise<void>;\r\n}\r\n\r\n@injectable()\r\nexport class MessageBrokerRpcHandler\r\n\t\t\textends rpc.RpcHandlerBase\r\n\t\t\timplements IMediateRpcHandler {\r\n\t\r\n\tprivate _registeredHandlers: IHandlerDetails[];\r\n\r\n\r\n\tconstructor(\r\n\t\t@inject(CmT.DEPENDENCY_CONTAINER) depContainer: IDependencyContainer,\r\n\t\t@inject(T.MSG_BROKER_CONNECTOR) private _msgBrokerConn: IMessageBrokerConnector\r\n\t) {\r\n\t\tsuper(depContainer);\r\n\t\tGuard.assertArgDefined('_msgBrokerConn', _msgBrokerConn);\r\n\t\tthis._registeredHandlers = [];\r\n\t}\r\n\r\n\r\n\t/**\r\n\t * @see IRpcHandler.init\r\n\t */\r\n\tpublic init(params?: any): void {\r\n\t\tthis._msgBrokerConn && this._msgBrokerConn.onError(err => this.emitError(err));\r\n\t}\r\n\r\n\t/**\r\n\t * @see IRpcHandler.start\r\n\t */\r\n\tpublic start(): Promise<void> {\r\n\t\treturn this._msgBrokerConn.listen(this.onMessage.bind(this));\r\n\t}\r\n\r\n\t/**\r\n\t * @see IRpcHandler.dispose\r\n\t */\r\n\tpublic dispose(): Promise<void> {\r\n\t\t// Stop listening then unsbuscribe all topic patterns.\r\n\t\treturn <any>Promise.all([\r\n\t\t\tthis._msgBrokerConn.stopListen(),\r\n\t\t\tthis._msgBrokerConn.unsubscribeAll()\r\n\t\t]);\r\n\t}\r\n\r\n\t/**\r\n\t * @see IMediateRpcHandler.handle\r\n\t */\r\n\tpublic async handle(actions: string | string[], dependencyIdentifier: string | symbol, actionFactory?: rpc.RpcActionFactory): Promise<void> {\r\n\t\tGuard.assertArgDefined('action', actions);\r\n\t\tGuard.assertArgDefined('dependencyIdentifier', dependencyIdentifier);\r\n\t\tGuard.assertIsDefined(this.name, '`name` property is required.');\r\n\r\n\t\tactions = Array.isArray(actions) ? actions : [actions];\r\n\t\treturn <any>Promise.all(\r\n\t\t\tactions.map(a => {\r\n\t\t\t\tthis._registeredHandlers[a] = { dependencyIdentifier, actionFactory };\r\n\t\t\t\treturn this._msgBrokerConn.subscribe(`request.${this.name}.${a}`);\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\t/**\r\n\t * @see IMediateRpcHandler.handleCRUD\r\n\t */\r\n\tpublic handleCRUD(dependencyIdentifier: string | symbol, actionFactory?: rpc.RpcActionFactory): Promise<void> {\r\n\t\treturn this.handle(\r\n\t\t\t['countAll', 'create', 'delete', 'find', 'patch', 'update'],\r\n\t\t\tdependencyIdentifier, actionFactory\r\n\t\t);\r\n\t}\r\n\r\n\r\n\tprivate onMessage(msg: IMessage): void {\r\n\t\tlet action = msg.raw.fields.routingKey.match(/[^\\.]+$/)[0],\r\n\t\t\thandlerDetails = this._registeredHandlers[action];\r\n\r\n\t\tlet request: rpc.IRpcRequest = msg.data,\r\n\t\t\treplyTo: string = msg.properties.replyTo,\r\n\t\t\tcorrelationId = msg.properties.correlationId;\r\n\r\n\t\t(new Promise((resolve, reject) => {\r\n\t\t\t\tlet actionFn = this.resolveActionFunc(action, handlerDetails.dependencyIdentifier, handlerDetails.actionFactory);\r\n\t\t\t\ttry {\r\n\t\t\t\t\t// Execute controller's action\r\n\t\t\t\t\tlet output: any = actionFn(request.payload, resolve, reject, request);\r\n\t\t\t\t\tif (output instanceof Promise) {\r\n\t\t\t\t\t\toutput.catch(reject); // Catch async exceptions.\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (err) { // Catch normal exceptions.\r\n\t\t\t\t\treject(err);\r\n\t\t\t\t}\r\n\t\t\t}))\r\n\t\t\t.then(result => { // When `actionFn` calls `resolve` from inside.\r\n\t\t\t\t// Sends response to reply topic\r\n\t\t\t\treturn this._msgBrokerConn.publish(replyTo, this.createResponse(true, result, request.from), { correlationId });\r\n\t\t\t})\r\n\t\t\t.catch(error => {\r\n\t\t\t\tlet errMsg = error;\r\n\t\t\t\t// If error is an uncaught Exception/Error object, that means the action method\r\n\t\t\t\t// has a problem. We should nack to tell message broker to send this message to someone else.\r\n\t\t\t\tif (error instanceof Error) {\r\n\t\t\t\t\t// Clone to a plain object, as class Error has problem\r\n\t\t\t\t\t// with JSON.stringify.\r\n\t\t\t\t\terrMsg = {\r\n\t\t\t\t\t\tmessage: error.message\r\n\t\t\t\t\t};\r\n\t\t\t\t} else if (error instanceof Exception) {\r\n\t\t\t\t\t// TODO: Should log this unexpected error.\r\n\t\t\t\t\tdelete error.stack;\r\n\t\t\t\t\t// nack(); // Disable this, because we use auto-ack.\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// If this is a custom error, which means the action method sends this error\r\n\t\t\t\t// back to caller on purpose.\r\n\t\t\t\treturn this._msgBrokerConn.publish(replyTo, this.createResponse(false, errMsg, request.from), { correlationId });\r\n\t\t\t});\r\n\t}\r\n\r\n}"]}